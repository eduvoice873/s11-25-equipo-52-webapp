generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String                        @id @default(cuid())
  name                String?
  email               String                        @unique
  password            String?
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime                      @default(now())
  updatedAt           DateTime                      @updatedAt
  activo              Boolean                       @default(true)
  organizacionId      String
  rol                 Rol
  accounts            Account[]
  categorias          Categoria[]
  formularios         Formulario[]
  revisiones          Revision[]
  revisionesRespuesta RevisionRespuestaFormulario[]
  sessions            Session[]
  testimoniosEditados Testimonio[]                  @relation("TestimoniosEditados")
  organizacion        Organizacion                  @relation(fields: [organizacionId], references: [id], onDelete: Cascade)

  @@index([organizacionId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Organizacion {
  id          String       @id @default(uuid())
  nombre      String
  slug        String       @unique
  creadoEn    DateTime     @default(now())
  categorias  Categoria[]
  etiquetas   Etiqueta[]
  formularios Formulario[]
  medios      Medio[]
  usuarios    User[]
}

model Persona {
  id             String                @id @default(uuid())
  nombreCompleto String
  correo         String                @unique
  fotoUrl        String?
  respuestas     RespuestaFormulario[]
  testimonios    Testimonio[]
}

model Categoria {
  id             String       @id @default(uuid())
  organizacionId String
  nombre         String
  creadoEn       DateTime     @default(now())
  creadoPorId    String
  mensaje        String?
  titulo         String?
  creadoPor      User         @relation(fields: [creadoPorId], references: [id])
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  formularios    Formulario[]
  preguntas      Pregunta[]
  testimonios    Testimonio[]

  @@index([organizacionId])
  @@index([creadoPorId])
}

model Pregunta {
  id          String    @id @default(uuid())
  texto       String
  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)

  @@index([categoriaId])
}

model Testimonio {
  id               String              @id @default(uuid())
  personaId        String
  modalidad        ModalidadTestimonio @default(texto_imagen)
  titulo           String
  texto            String?
  estado           EstadoTestimonio    @default(borrador)
  destacado        Boolean             @default(false)
  calificacion     Int                 @default(5)
  publicadoEn      DateTime?
  actualizadoPorId String?
  creadoEn         DateTime            @default(now())
  actualizadoEn    DateTime            @updatedAt
  categoriaId      String
  medios           Medio[]
  revisiones       Revision[]
  actualizadoPor   User?               @relation("TestimoniosEditados", fields: [actualizadoPorId], references: [id])
  categoria        Categoria           @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  persona          Persona             @relation(fields: [personaId], references: [id])
  etiquetas        Etiqueta[]          @relation("EtiquetaToTestimonio")

  @@index([categoriaId])
  @@index([personaId])
  @@index([actualizadoPorId])
}

model Medio {
  id               String       @id @default(uuid())
  organizacionId   String
  testimonioId     String
  tipo             TipoMedio
  url              String
  ancho            Int
  alto             Int
  duracionSegundos Int?
  bytes            BigInt?
  leyenda          String?
  creadoEn         DateTime     @default(now())
  organizacion     Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  testimonio       Testimonio   @relation(fields: [testimonioId], references: [id], onDelete: Cascade)

  @@index([organizacionId])
  @@index([testimonioId])
}

model Etiqueta {
  id             String       @id @default(uuid())
  organizacionId String
  nombre         String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  testimonios    Testimonio[] @relation("EtiquetaToTestimonio")

  @@index([organizacionId])
}

model Revision {
  id           String           @id @default(uuid())
  testimonioId String
  revisorId    String
  decision     DecisionRevision
  notas        String?
  creadoEn     DateTime         @default(now())
  revisor      User             @relation(fields: [revisorId], references: [id], onDelete: Cascade)
  testimonio   Testimonio       @relation(fields: [testimonioId], references: [id], onDelete: Cascade)

  @@index([testimonioId])
  @@index([revisorId])
}

model Formulario {
  id                  String                @id @default(cuid())
  organizacionId      String
  categoriaId         String
  creadoPorId         String
  nombreFormulario    String
  descripcion         String?
  slugPublico         String                @unique
  pedirNombre         Boolean               @default(true)
  pedirCorreo         Boolean               @default(true)
  permitirTexto       Boolean               @default(true)
  permitirTextoImagen Boolean               @default(false)
  permitirVideo       Boolean               @default(false)
  mensajeGracias      String?
  creadoEn            DateTime              @default(now())
  actualizadoEn       DateTime              @updatedAt
  estado              EstadoFormulario      @default(publicado)
  categoria           Categoria             @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  creadoPor           User                  @relation(fields: [creadoPorId], references: [id], onDelete: Cascade)
  organizacion        Organizacion          @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  preguntas           PreguntaFormulario[]
  respuestas          RespuestaFormulario[]

  @@unique([slugPublico, organizacionId])
  @@index([organizacionId])
  @@index([categoriaId])
  @@index([creadoPorId])
}

model PreguntaFormulario {
  id           String     @id @default(cuid())
  formularioId String
  texto        String
  tipo         String     @default("texto")
  requerida    Boolean    @default(false)
  orden        Int        @default(0)
  opciones     String?
  creadoEn     DateTime   @default(now())
  formulario   Formulario @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  @@index([formularioId])
}

model RespuestaFormulario {
  id                  String                       @id @default(cuid())
  formularioId        String
  personaId           String?
  nombreCompleto      String?
  correo              String?
  titulo              String
  texto               String?
  calificacion        Int                          @default(5)
  estado              String                       @default("pendiente")
  creadoEn            DateTime                     @default(now())
  imagenPublicId      String?
  imagenUrl           String?
  videoPublicId       String?
  videoUrl            String?
  respuestasPreguntas Json?
  formulario          Formulario                   @relation(fields: [formularioId], references: [id], onDelete: Cascade)
  persona             Persona?                     @relation(fields: [personaId], references: [id])
  revisiones          RevisionRespuestaFormulario[]

  @@index([formularioId])
  @@index([personaId])
}

model RevisionRespuestaFormulario {
  id                    String              @id @default(uuid())
  respuestaFormularioId String
  revisorId             String
  decision              String
  notas                 String?
  creadoEn              DateTime            @default(now())
  revisor               User                @relation(fields: [revisorId], references: [id], onDelete: Cascade)
  respuestaFormulario   RespuestaFormulario @relation(fields: [respuestaFormularioId], references: [id], onDelete: Cascade)

  @@index([respuestaFormularioId])
  @@index([revisorId])
}

enum EstadoFormulario {
  borrador
  publicado
}

enum EstadoTestimonio {
  borrador
  en_revision
  aprobado
  publicado
  rechazado
  archivado
}

enum TipoMedio {
  imagen
  video
}

enum TipoCategoria {
  producto
  evento
  cliente
  industria
  servicio
}

enum DecisionRevision {
  aprobar
  rechazar
  editar
}

enum ModalidadTestimonio {
  texto_imagen
  video
}

enum Rol {
  admin
  editor
}
