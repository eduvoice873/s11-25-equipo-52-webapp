generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ENUMS

enum EstadoTestimonio {
  borrador
  en_revision
  aprobado
  publicado
  rechazado
  archivado
}

enum TipoMedio {
  imagen
  video
}

enum TipoCategoria {
  producto
  evento
  cliente
  industria
  servicio
}

enum DecisionRevision {
  aprobar
  rechazar
}

enum ModalidadTestimonio {
  texto_imagen
  video
}

enum Rol {
  admin
  editor
}

model User {
  id                 String              @id @default(uuid())
  name               String
  email              String              @unique
  password           String
  emailVerified      DateTime?
  image              String?
  activo             Boolean
  rol                Rol
  organizacionId     String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  organizacion       Organizacion        @relation(fields: [organizacionId], references: [id])
  accounts           Account[]
  sessions           Session[]
  testimonios        Testimonio[]
  revisiones         Revision[]
  verificationTokens VerificationToken[]
  categorias         Categoria[]
}

model Account {
  provider          String
  providerAccountId String
  userId            String
  type              String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@id([sessionToken])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  user User @relation(fields: [identifier], references: [id])

  @@id([identifier, token])
}

model Organizacion {
  id         String      @id
  nombre     String
  slug       String      @unique
  creadoEn   DateTime    @default(now())
  categorias Categoria[]
  users      User[]
  medios     Medio[]
  etiquetas  Etiqueta[]
}

model Categoria {
  id             String        @id
  organizacionId String
  creadoPorId    String
  tipo           TipoCategoria
  nombre         String
  titulo         String
  mensaje        String
  creadoEn       DateTime      @default(now())

  organizacion Organizacion @relation(fields: [organizacionId], references: [id])
  creadoPor    User         @relation(fields: [creadoPorId], references: [id])
  preguntas    Pregunta[]
  testimonios  Testimonio[]
}

model Pregunta {
  id        String @id
  espacioId String
  texto     String

  espacio Categoria @relation(fields: [espacioId], references: [id])
}

model Testimonio {
  id               String              @id
  espacioId        String
  nombreCompleto   String
  correo           String
  fotoUrl          String?
  modalidad        ModalidadTestimonio
  titulo           String
  texto            String
  estado           EstadoTestimonio
  destacado        Boolean
  calificacion     Int
  publicadoEn      DateTime?
  actualizadoPorId String
  creadoEn         DateTime            @default(now())
  actualizadoEn    DateTime            @updatedAt

  espacio        Categoria             @relation(fields: [espacioId], references: [id])
  actualizadoPor User                  @relation(fields: [actualizadoPorId], references: [id])
  revision       Revision[]
  medios         Medio[]
  etiquetas      Testimonio_Etiqueta[]
}

model Medio {
  id               String    @id
  organizacionId   String
  testimonioId     String
  tipo             TipoMedio
  url              String
  ancho            Int
  alto             Int
  duracionSegundos Int
  bytes            BigInt
  leyenda          String
  creadoEn         DateTime  @default(now())

  organizacion Organizacion @relation(fields: [organizacionId], references: [id])
  testimonio   Testimonio   @relation(fields: [testimonioId], references: [id])
}

model Etiqueta {
  id             String @id
  organizacionId String
  nombre         String

  organizacion Organizacion          @relation(fields: [organizacionId], references: [id])
  testimonios  Testimonio_Etiqueta[]
}

model Revision {
  id           String           @id
  testimonioId String
  revisorId    String
  decision     DecisionRevision
  notas        String?
  creadoEn     DateTime         @default(now())

  testimonio Testimonio @relation(fields: [testimonioId], references: [id])
  revisor    User       @relation(fields: [revisorId], references: [id])
}

model Testimonio_Etiqueta {
  testimonioId String
  etiquetaId   String

  testimonio Testimonio @relation(fields: [testimonioId], references: [id])
  etiqueta   Etiqueta   @relation(fields: [etiquetaId], references: [id])

  @@id([testimonioId, etiquetaId])
}
