generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String       @id @default(cuid())
  name                String?
  email               String       @unique
  password            String?
  emailVerified       DateTime?
  image               String?
  activo              Boolean      @default(true)
  rol                 Rol
  organizacionId      String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  accounts            Account[]
  categorias          Categoria[]
  revisiones          Revision[]
  sessions            Session[]
  testimoniosEditados Testimonio[]
  organizacion        Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  formularios         Formulario[]

  @@index([organizacionId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Organizacion {
  id         String      @id @default(uuid())
  nombre     String
  slug       String      @unique
  creadoEn   DateTime    @default(now())
  categorias Categoria[]
  etiquetas  Etiqueta[]
  medios     Medio[]
  usuarios   User[]
  formularios Formulario[]
}

model Persona {
  id             String       @id @default(uuid())
  nombreCompleto String
  correo         String       @unique
  fotoUrl        String?
  testimonios    Testimonio[]
  respuestas     RespuestaFormulario[]
}

model Categoria {
  id             String       @id @default(uuid())
  organizacionId String
  creadoPorId    String
  nombre         String
  titulo         String?
  mensaje        String?
  creadoEn       DateTime     @default(now())
  creadoPor      User         @relation(fields: [creadoPorId], references: [id])
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  preguntas      Pregunta[]
  testimonios    Testimonio[]
  formularios    Formulario[]

  @@index([organizacionId])
  @@index([creadoPorId])
}

model Pregunta {
  id          String    @id @default(uuid())
  categoriaId String
  texto       String
  categoria   Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)

  @@index([categoriaId])
}

model Testimonio {
  id               String              @id @default(uuid())
  categoriaId      String
  personaId        String
  modalidad        ModalidadTestimonio @default(texto_imagen)
  titulo           String
  texto            String?
  estado           EstadoTestimonio    @default(borrador)
  destacado        Boolean             @default(false)
  calificacion     Int                 @default(5)
  publicadoEn      DateTime?
  actualizadoPorId String?
  creadoEn         DateTime            @default(now())
  actualizadoEn    DateTime            @updatedAt
  medios           Medio[]
  revisiones       Revision[]
  actualizadoPor   User?               @relation(fields: [actualizadoPorId], references: [id])
  categoria        Categoria           @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  persona          Persona             @relation(fields: [personaId], references: [id])
  etiquetas        Etiqueta[]          @relation("EtiquetaToTestimonio")

  @@index([categoriaId])
  @@index([personaId])
  @@index([actualizadoPorId])
}

model Medio {
  id               String       @id @default(uuid())
  organizacionId   String
  testimonioId     String
  tipo             TipoMedio
  url              String
  ancho            Int
  alto             Int
  duracionSegundos Int?
  bytes            BigInt?
  leyenda          String?
  creadoEn         DateTime     @default(now())
  organizacion     Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  testimonio       Testimonio   @relation(fields: [testimonioId], references: [id], onDelete: Cascade)

  @@index([organizacionId])
  @@index([testimonioId])
}

model Etiqueta {
  id             String       @id @default(uuid())
  organizacionId String
  nombre         String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  testimonios    Testimonio[] @relation("EtiquetaToTestimonio")

  @@index([organizacionId])
}

model Revision {
  id           String           @id @default(uuid())
  testimonioId String
  revisorId    String
  decision     DecisionRevision
  notas        String?
  creadoEn     DateTime         @default(now())
  revisor      User             @relation(fields: [revisorId], references: [id], onDelete: Cascade)
  testimonio   Testimonio       @relation(fields: [testimonioId], references: [id], onDelete: Cascade)

  @@index([testimonioId])
  @@index([revisorId])
}

model Formulario {
  id                  String       @id @default(cuid())
  organizacionId      String
  categoriaId         String
  creadoPorId         String
  nombreFormulario    String
  descripcion         String?
  slugPublico         String       @unique
  pedirNombre         Boolean      @default(true)
  pedirCorreo         Boolean      @default(true)
  permitirTexto       Boolean      @default(true)
  permitirTextoImagen Boolean      @default(false)
  permitirVideo       Boolean      @default(false)
  mensajeGracias      String?
  estado              EstadoFormulario      @default(publicado)
  creadoEn            DateTime     @default(now())
  actualizadoEn       DateTime     @updatedAt

  // Relaciones
  organizacion        Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  categoria           Categoria    @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  creadoPor           User         @relation(fields: [creadoPorId], references: [id], onDelete: Cascade)
  preguntas           PreguntaFormulario[]
  respuestas          RespuestaFormulario[]

  @@index([organizacionId])
  @@index([categoriaId])
  @@index([creadoPorId])
  @@unique([slugPublico, organizacionId])
}

model PreguntaFormulario {
  id            String   @id @default(cuid())
  formularioId  String
  titulo        String
  tipo          String   @default("texto") // "texto", "seleccion", "si_no", etc
  requerida     Boolean  @default(false)
  orden         Int      @default(0)
  opciones      String?  // JSON array como string
  creadoEn      DateTime @default(now())

  formulario    Formulario @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  @@index([formularioId])
}

model RespuestaFormulario {
  id             String   @id @default(cuid())
  formularioId   String
  personaId      String?
  nombreCompleto String?
  correo         String?
  titulo         String
  texto          String
  calificacion   Int      @default(5)
  estado         String   @default("pendiente") // "pendiente", "aprobado", "rechazado"
  creadoEn       DateTime @default(now())
  imagenUrl String?
  videoUrl  String?
  imagenPublicId String?
  videoPublicId  String?

  formulario     Formulario @relation(fields: [formularioId], references: [id], onDelete: Cascade)
  persona        Persona?   @relation(fields: [personaId], references: [id])

  @@index([formularioId])
  @@index([personaId])
}

enum EstadoFormulario {
  borrador
  publicado
}

enum EstadoTestimonio {
  borrador
  en_revision
  aprobado
  publicado
  rechazado
  archivado
}

enum TipoMedio {
  imagen
  video
}

enum TipoCategoria {
  producto
  evento
  cliente
  industria
  servicio
}

enum DecisionRevision {
  aprobar
  rechazar
}

enum ModalidadTestimonio {
  texto_imagen
  video
}

enum Rol {
  admin
  editor
}
